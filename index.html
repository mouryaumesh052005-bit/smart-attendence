<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Smart Attendance System</title>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
<style>
body {font-family:"Segoe UI",sans-serif;background:linear-gradient(135deg,#eef2f7,#dfe9f3);margin:0;padding:20px;color:#333;}
h1,h2{text-align:center;}
.card{background:white;border-radius:14px;padding:25px;box-shadow:0 6px 20px rgba(0,0,0,0.1);margin:20px auto;max-width:1000px;}
.qr-container{display:flex;justify-content:center;align-items:center;gap:25px;margin-bottom:20px;}
#qrcode{padding:15px;background:white;border-radius:12px;box-shadow:0 0 15px rgba(0,0,0,0.15);}
button{padding:10px 20px;background:#2563eb;color:white;border:none;border-radius:8px;cursor:pointer;transition:0.3s;}
button:hover{background:#1d4ed8;}
button.clear-btn{background:#e11d48;} button.clear-btn:hover{background:#b91c1c;}
table{width:100%;border-collapse:collapse;background:white;border-radius:10px;overflow:hidden;margin-top:20px;table-layout:fixed;}
th,td{padding:12px;text-align:center;border-bottom:1px solid #eee;word-wrap:break-word;}
th{background:#2563eb;color:white;}
tr:hover td{background:#f9faff;}
.tick{color:green;font-weight:bold;} .cross{color:red;font-weight:bold;} .pending{color:orange;font-weight:bold;}
.entry-badge{color:white;background:#16a34a;padding:5px 10px;border-radius:8px;font-weight:bold;}
.exit-badge{color:white;background:#10b981;padding:5px 10px;border-radius:8px;font-weight:bold;}
.form-container{margin:30px auto;background:white;padding:25px;border-radius:12px;width:350px;box-shadow:0 4px 15px rgba(0,0,0,0.1);}
input{width:90%;padding:12px;margin:12px 0;border:1px solid #ccc;border-radius:6px;font-size:14px;}
@media screen and (max-width:600px){.qr-container{flex-direction:column;gap:15px;}.form-container{width:90%;}}
.table-wrapper{max-height:500px;overflow-y:auto;}
</style>
</head>
<body>

<h1>üìå Smart Attendance System</h1>

<div id="teacher-view" class="card">
<h2>Teacher Dashboard</h2>
<div class="qr-container">
<div id="qrcode"></div>
<div>
<button onclick="generateQR()">üîÑ Generate QR</button><br><br>
<button class="clear-btn" onclick="clearRecords()">üóë Clear Records</button>
</div>
</div>
<div class="table-wrapper">
<table id="attendance-table">
<thead>
<tr>
<th>Name</th>
<th>Roll No</th>
<th>Entry</th>
<th>Exit</th>
<th>Attendance</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>

<div id="student-view" class="form-container" style="display:none;">
<h2>Attendance Form</h2>
<input type="text" id="name" placeholder="Enter Name"><br>
<input type="text" id="roll" placeholder="Enter Roll No"><br>
<button onclick="markAttendance()">Submit</button>
</div>

<script>
// ===== Firebase Setup =====
const firebaseConfig = {
  apiKey: "AIzaSyCI37gCUH4LvAH33bBly2bqA32Y0_0uaXE",
  authDomain: "smart-7c964.firebaseapp.com",
  databaseURL: "https://smart-7c964-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "smart-7c964",
  storageBucket: "smart-7c964.appspot.com",
  messagingSenderId: "22399720510",
  appId: "1:22399720510:web:a91e5bf63f0172ad48456f"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ===== QR Code =====
const studentLink = "https://mouryaumesh052005-bit.github.io/smart-attendence/?mode=student";
function generateQR(){
  document.getElementById("qrcode").innerHTML="";
  new QRCode(document.getElementById("qrcode"),{text:studentLink,width:200,height:200});
}
generateQR();

// ===== Detect Student Mode =====
const params = new URLSearchParams(window.location.search);
if(params.get("mode")==="student"){
  document.getElementById("teacher-view").style.display="none";
  document.getElementById("student-view").style.display="block";
}

// ===== Load Attendance Table =====
function loadAttendance(){
  if(params.get("mode")==="student") return;
  db.ref("attendance").once("value", snapshot=>{
    const data = snapshot.val() || {};
    const tbody = document.querySelector("#attendance-table tbody");
    tbody.innerHTML = "";
    const now = Date.now();
    Object.values(data).forEach(s=>{
      if(!s.exit && s.entryTime && now - s.entryTime > 3600000){
        s.status="Absent";
        db.ref("attendance/"+s.roll).update({status:"Absent"});
      }
      const entryBadge = s.entry ? `<span class="entry-badge">‚úî ${s.entry}</span>` : `<span class="absent-badge">‚úñ</span>`;
      const exitBadge = s.exit ? `<span class="exit-badge">‚úî ${s.exit}</span>` : `<span class="absent-badge">‚úñ</span>`;
      const statusHTML = s.status==="Present"?`<span class="tick">‚úî Present</span>`:s.status==="Absent"?`<span class="cross">‚úñ Absent</span>`:`<span class="pending">‚è≥ Pending</span>`;
      tbody.innerHTML += `<tr>
        <td>${s.name}</td>
        <td>${s.roll}</td>
        <td>${entryBadge}</td>
        <td>${exitBadge}</td>
        <td>${statusHTML}</td>
      </tr>`;
    });
  });
}
loadAttendance();
if(!params.get("mode")) setInterval(loadAttendance,2000);

// ===== Mark Attendance =====
function markAttendance(){
  const name = document.getElementById("name").value.trim();
  const roll = document.getElementById("roll").value.trim();
  if(!name || !roll){ alert("‚ùå Fill all details"); return; }
  const time = new Date().toLocaleTimeString();
  const timestamp = Date.now();
  const studentRef = db.ref("attendance/"+roll);

  studentRef.once("value").then(snapshot=>{
    const data = snapshot.val();
    let message = "";
    if(!data){
      // First time ‚Üí entry pending
      studentRef.set({name, roll, entry:time, entryTime:timestamp, exit:"", status:"Pending"});
      message = "‚úÖ Entry Recorded, Attendance Pending";
    } else if(!data.exit){
      // Second time ‚Üí exit + present
      studentRef.update({exit:time, status:"Present"});
      message = "‚úÖ Exit Recorded, Attendance Present";
    } else {
      message = "‚Ñπ Already Submitted";
    }
    alert(message);
    document.getElementById("name").value="";
    document.getElementById("roll").value="";
    loadAttendance();
  });
}

// ===== Clear Records =====
function clearRecords(){
  if(confirm("‚ö† Clear all records?")){
    db.ref("attendance").remove();
    loadAttendance();
  }
}
</script>
</body>
</html>
