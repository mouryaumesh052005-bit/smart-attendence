<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Smart Attendance System</title>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
<!-- Firebase CDN v8 style -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js"></script>

<style>
body {font-family:"Segoe UI", sans-serif; background:linear-gradient(135deg,#eef2f7,#dfe9f3); margin:0; padding:20px; text-align:center; color:#333;}
h1{margin-bottom:10px;color:#222;}
h2{margin-bottom:15px;color:#111;}
.card{background:white;border-radius:14px;padding:25px;box-shadow:0 6px 20px rgba(0,0,0,0.1);margin:25px auto;width:90%;max-width:900px;}
.qr-container{display:flex;justify-content:center;align-items:center;gap:25px;margin:25px auto;}
#qrcode{padding:15px;background:white;border-radius:12px;box-shadow:0 0 15px rgba(0,0,0,0.15);}
button{padding:12px 20px;background:#2563eb;color:white;font-size:15px;border:none;border-radius:8px;cursor:pointer;transition:0.3s;}
button:hover{background:#1d4ed8;}
button.clear-btn{background:#e11d48;}
button.clear-btn:hover{background:#b91c1c;}
table{width:100%;border-collapse:collapse;background:white;border-radius:10px;overflow:hidden;margin-top:20px;}
th,td{padding:14px;text-align:center;border-bottom:1px solid #eee;}
th{background:#2563eb;color:white;}
tr:hover td{background:#f9faff;}
.tick{color:green;font-weight:bold;}
.cross{color:red;font-weight:bold;}
.entry-badge{color:white;background:#16a34a;padding:5px 10px;border-radius:8px;font-weight:bold;}
.exit-badge{color:white;background:#10b981;padding:5px 10px;border-radius:8px;font-weight:bold;}
.absent-badge{color:white;background:#ef4444;padding:5px 10px;border-radius:8px;font-weight:bold;}
.form-container{margin-top:30px;background:white;padding:25px;border-radius:12px;width:350px;margin-left:auto;margin-right:auto;box-shadow:0 4px 15px rgba(0,0,0,0.1);}
input{width:90%;padding:12px;margin:12px 0;border:1px solid #ccc;border-radius:6px;font-size:14px;}
@media screen and (max-width:500px){.qr-container{flex-direction:column;gap:15px;}.form-container{width:90%;}}
</style>
</head>
<body>

<h1>ðŸ“Œ Smart Attendance System</h1>

<!-- TEACHER DASHBOARD -->
<div id="teacher-view" class="card" style="display:none;">
<h2>Teacher Dashboard</h2>
<div class="qr-container">
<div id="qrcode"></div>
<div>
<button onclick="generateQR()">ðŸ”„ Generate QR</button><br><br>
<button class="clear-btn" onclick="clearRecords()">ðŸ—‘ Clear Records</button>
</div>
</div>

<table id="attendance-table">
<thead>
<tr>
<th>Name</th>
<th>Roll No</th>
<th>Entry</th>
<th>Exit</th>
<th>Status</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<!-- STUDENT FORM -->
<div id="student-view" class="form-container" style="display:none;">
<h2>Attendance Form</h2>
<input type="text" id="name" placeholder="Enter Name"><br>
<input type="text" id="roll" placeholder="Enter Roll No"><br>
<button onclick="markAttendance()">Submit</button>
</div>

<script>
  // Firebase Config
  var firebaseConfig = {
    apiKey: "AIzaSyCI37gCUH4LvAH33bBly2bqA32Y0_0uaXE",
    authDomain: "smart-7c964.firebaseapp.com",
    databaseURL: "https://smart-7c964-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "smart-7c964",
    storageBucket: "smart-7c964.firebasestorage.app",
    messagingSenderId: "22399720510",
    appId: "1:22399720510:web:a91e5bf63f0172ad48456f"
  };
  firebase.initializeApp(firebaseConfig);
  var db = firebase.database();

  // Detect mode
  const params = new URLSearchParams(window.location.search);
  const mode = params.get("mode");
  if(mode==="student") document.getElementById("student-view").style.display="block";
  if(mode==="teacher") document.getElementById("teacher-view").style.display="block";

  // QR Code
  const studentLink = window.location.origin + window.location.pathname + "?mode=student";
  function generateQR(){
    document.getElementById("qrcode").innerHTML="";
    new QRCode(document.getElementById("qrcode"), {text: studentLink, width:200, height:200});
  }
  if(mode==="teacher") generateQR();

  // Attendance
  function markAttendance(){
    const name = document.getElementById("name").value.trim();
    const roll = document.getElementById("roll").value.trim();
    if(!name || !roll){alert("âŒ Fill all details"); return;}
    const now = Date.now();
    const studentRef = db.ref("attendance/"+roll);

    studentRef.get().then(snapshot=>{
      const data = snapshot.val();
      if(!data){
        studentRef.set({name, roll, entry: now, exit: "", status: "Pending"});
        alert("âœ… Entry Recorded!");
      } else if(!data.exit){
        studentRef.update({exit: now, status: "Present"});
        alert("âœ… Exit Recorded, Present!");
      } else {
        alert("â„¹ Already Submitted");
      }
    });

    document.getElementById("name").value="";
    document.getElementById("roll").value="";
  }

  // Load teacher table
  if(mode==="teacher"){
    const tbody = document.querySelector("#attendance-table tbody");
    const attendanceRef = db.ref("attendance");
    attendanceRef.on("value", snapshot=>{
      tbody.innerHTML="";
      snapshot.forEach(child=>{
        const s = child.val();
        const entryBadge = s.entry ? `<span class="entry-badge">âœ” ${new Date(s.entry).toLocaleTimeString()}</span>` : `<span class="absent-badge">âœ–</span>`;
        const exitBadge = s.exit ? `<span class="exit-badge">âœ” ${new Date(s.exit).toLocaleTimeString()}</span>` : `<span class="absent-badge">âœ–</span>`;
        const statusBadge = s.status==="Present" ? `<span class="tick">âœ” Present</span>` : s.status==="Pending" ? `<span class="cross">âŒ› Pending</span>` : `<span class="cross">âœ– Absent</span>`;
        tbody.innerHTML += `<tr>
          <td>${s.name}</td>
          <td>${s.roll}</td>
          <td>${entryBadge}</td>
          <td>${exitBadge}</td>
          <td>${statusBadge}</td>
        </tr>`;
      });
    });

    // Auto absent after 1 hour
    setInterval(()=>{
      attendanceRef.get().then(snapshot=>{
        snapshot.forEach(child=>{
          const s = child.val();
          if(s.status==="Pending" && Date.now()-s.entry>3600000){
            db.ref("attendance/"+s.roll).update({status:"Absent"});
          }
        });
      });
    },60000);
  }

  // Clear
  function clearRecords(){
    if(confirm("âš  Clear all records?")){
      db.ref("attendance").remove();
    }
  }
</script>

</body>
</html>
